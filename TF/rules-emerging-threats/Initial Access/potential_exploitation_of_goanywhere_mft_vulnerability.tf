resource "azurerm_sentinel_alert_rule_scheduled" "potential_exploitation_of_goanywhere_mft_vulnerability" {
  name                       = "potential_exploitation_of_goanywhere_mft_vulnerability"
  log_analytics_workspace_id = var.workspace_id
  display_name               = "Potential Exploitation of GoAnywhere MFT Vulnerability"
  description                = "Detects suspicious command execution by child processes of the GoAnywhere Managed File Transfer (MFT) application, which may indicate exploitation such as CVE-2025-10035. This behavior is indicative of post-exploitation activity related to CVE-2025-10035, as observed in campaigns by the threat actor Storm-1175. - Legitimate administrative scripts or built-in GoAnywhere functions could potentially trigger this rule. Tuning may be required based on normal activity in your environment."
  severity                   = "High"
  query                      = <<QUERY
DeviceProcessEvents
| where InitiatingProcessFolderPath contains "\\GoAnywhere\\tomcat\\" and ((((ProcessCommandLine contains "IEX" and ProcessCommandLine contains "enc" and ProcessCommandLine contains "Hidden" and ProcessCommandLine contains "bypass") or (ProcessCommandLine matches regex "net\\s+user" or ProcessCommandLine matches regex "net\\s+group" or ProcessCommandLine matches regex "query\\s+session") or (ProcessCommandLine contains "whoami" or ProcessCommandLine contains "systeminfo" or ProcessCommandLine contains "dsquery" or ProcessCommandLine contains "localgroup administrators" or ProcessCommandLine contains "nltest" or ProcessCommandLine contains "samaccountname=" or ProcessCommandLine contains "adscredentials" or ProcessCommandLine contains "o365accountconfiguration" or ProcessCommandLine contains ".DownloadString(" or ProcessCommandLine contains ".DownloadFile(" or ProcessCommandLine contains "FromBase64String(" or ProcessCommandLine contains "System.IO.Compression" or ProcessCommandLine contains "System.IO.MemoryStream" or ProcessCommandLine contains "curl")) and (FolderPath endswith "\\powershell.exe" or FolderPath endswith "\\powershell_ise.exe" or FolderPath endswith "\\pwsh.exe")) or (((ProcessCommandLine contains "powershell" or ProcessCommandLine contains "whoami" or ProcessCommandLine contains "net.exe" or ProcessCommandLine contains "net1.exe" or ProcessCommandLine contains "rundll32" or ProcessCommandLine contains "quser" or ProcessCommandLine contains "nltest" or ProcessCommandLine contains "curl") and FolderPath endswith "\\cmd.exe") or (ProcessCommandLine contains "bitsadmin" or ProcessCommandLine contains "certutil" or ProcessCommandLine contains "mshta" or ProcessCommandLine contains "cscript" or ProcessCommandLine contains "wscript")))
QUERY
  query_frequency            = "PT1H"
  query_period               = "PT1H"
  trigger_operator           = "GreaterThan"
  trigger_threshold          = 0
  suppression_enabled        = false
  suppression_duration       = "PT5H"
  tactics                    = ["InitialAccess", "Execution", "Persistence"]
  techniques                 = ["T1190", "T1059", "T1133"]
  enabled                    = true

  incident {
    create_incident_enabled = true
    grouping {
      enabled                 = false
      lookback_duration       = "PT5H"
      reopen_closed_incidents = false
      entity_matching_method  = "AllEntities"
      by_entities             = []
      by_alert_details        = []
      by_custom_details       = []
    }
  }

  event_grouping {
    aggregation_method = "SingleAlert"
  }

  entity_mapping {
    entity_type = "Process"
    field_mapping {
      identifier  = "CommandLine"
      column_name = "ProcessCommandLine"
    }
    field_mapping {
      identifier  = "ProcessPath"
      column_name = "FolderPath"
    }
  }

  entity_mapping {
    entity_type = "File"
    field_mapping {
      identifier  = "Directory"
      column_name = "FolderPath"
    }
  }
}