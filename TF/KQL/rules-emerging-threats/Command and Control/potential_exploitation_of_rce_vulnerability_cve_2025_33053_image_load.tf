resource "azurerm_sentinel_alert_rule_scheduled" "potential_exploitation_of_rce_vulnerability_cve_2025_33053_image_load" {
  name                       = "potential_exploitation_of_rce_vulnerability_cve_2025_33053_image_load"
  log_analytics_workspace_id = var.workspace_id
  display_name               = "Potential Exploitation of RCE Vulnerability CVE-2025-33053 - Image Load"
  description                = "Detects potential exploitation of remote code execution vulnerability CVE-2025-33053 by monitoring suspicious image loads from WebDAV paths. The exploit involves malicious executables from attacker-controlled WebDAV servers loading the Windows system DLLs like gdi32.dll, netapi32.dll, etc."
  severity                   = "High"
  query                      = <<QUERY
DeviceImageLoadEvents
| where (InitiatingProcessFolderPath endswith "\\route.exe" or InitiatingProcessFolderPath endswith "\\netsh.exe" or InitiatingProcessFolderPath endswith "\\makecab.exe" or InitiatingProcessFolderPath endswith "\\dxdiag.exe" or InitiatingProcessFolderPath endswith "\\ipconfig.exe" or InitiatingProcessFolderPath endswith "\\explorer.exe") and (InitiatingProcessFolderPath contains "\\DavWWWRoot\\" and InitiatingProcessFolderPath startswith "\\\\")
QUERY
  query_frequency            = "PT1H"
  query_period               = "PT1H"
  trigger_operator           = "GreaterThan"
  trigger_threshold          = 0
  suppression_enabled        = false
  suppression_duration       = "PT5H"
  tactics                    = ["CommandAndControl", "Execution", "DefenseEvasion", "LateralMovement"]
  techniques                 = ["T1218", "T1105"]
  enabled                    = true

  incident {
    create_incident_enabled = true
    grouping {
      enabled                 = false
      lookback_duration       = "PT5H"
      reopen_closed_incidents = false
      entity_matching_method  = "AllEntities"
      by_entities             = []
      by_alert_details        = []
      by_custom_details       = []
    }
  }

  event_grouping {
    aggregation_method = "SingleAlert"
  }

  entity_mapping {
    entity_type = "Process"
    field_mapping {
      identifier  = "ProcessPath"
      column_name = "FolderPath"
    }
  }

  entity_mapping {
    entity_type = "File"
    field_mapping {
      identifier  = "Directory"
      column_name = "FolderPath"
    }
  }
}