id: 87a656b8-b3e3-5e26-8a00-425ffc00b371
name: Potential SystemNightmare Exploitation Attempt
description: Detects an exploitation attempt of SystemNightmare in order to obtain a shell as LOCAL_SYSTEM
severity: High
queryFrequency: PT1H
queryPeriod: PT1H
triggerOperator: gt
triggerThreshold: 0
tactics:
- PrivilegeEscalation
query: |-
  DeviceProcessEvents
  | where ProcessCommandLine contains "printnightmare.gentilkiwi.com" or ProcessCommandLine contains " /user:gentilguest " or ProcessCommandLine contains "Kiwi Legit Printer"
version: 1.0.0
kind: Scheduled
relevantTechniques:
- T1068
entityMappings:
- entityType: Process
  fieldMappings:
  - identifier: CommandLine
    columnName: ProcessCommandLine
requiredDataConnectors:
- connectorId: MicrosoftThreatProtection
  dataTypes:
  - DeviceProcessEvents
