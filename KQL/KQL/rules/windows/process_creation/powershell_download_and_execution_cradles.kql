// Title: PowerShell Download and Execution Cradles
// Author: Florian Roth (Nextron Systems)
// Date: 2022-03-24
// Level: high
// Description: Detects PowerShell download and execution cradles.
// MITRE Tactic: Execution
// Tags: attack.execution, attack.t1059
// False Positives:
//   - Some PowerShell installers were seen using similar combinations. Apply filters accordingly

DeviceProcessEvents
| where (ProcessCommandLine contains ".DownloadString(" or ProcessCommandLine contains ".DownloadFile(" or ProcessCommandLine contains "Invoke-WebRequest " or ProcessCommandLine contains "iwr " or ProcessCommandLine contains "Invoke-RestMethod " or ProcessCommandLine contains "irm ") and (ProcessCommandLine contains ";iex $" or ProcessCommandLine contains "| IEX" or ProcessCommandLine contains "|IEX " or ProcessCommandLine contains "I`E`X" or ProcessCommandLine contains "I`EX" or ProcessCommandLine contains "IE`X" or ProcessCommandLine contains "iex " or ProcessCommandLine contains "IEX (" or ProcessCommandLine contains "IEX(" or ProcessCommandLine contains "Invoke-Expression")