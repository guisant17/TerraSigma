// Title: Suspicious Process Spawned by CentreStack Portal AppPool
// Author: Jason Rathbun (Blackpoint Cyber)
// Date: 2025-04-17
// Level: high
// Description: Detects unexpected command shell execution (cmd.exe) from w3wp.exe when tied to CentreStack's portal.config, indicating potential exploitation (e.g., CVE-2025-30406)
// MITRE Tactic: Persistence
// Tags: attack.persistence, attack.execution, attack.t1059.003, attack.t1505.003, cve.2025-30406, detection.emerging-threats
// False Positives:
//   - Potentially if other portal services run on w3wp with a apppool\portal\portal.config, if you want to increase scope you could add user IIS APPPOOL\portal.

DeviceProcessEvents
| where FolderPath endswith "\\cmd.exe" and InitiatingProcessCommandLine contains "\\portal\\portal.config" and InitiatingProcessFolderPath endswith "\\w3wp.exe"