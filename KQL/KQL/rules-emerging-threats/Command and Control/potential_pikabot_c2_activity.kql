// Title: Potential Pikabot C2 Activity
// Author: Andreas Braathen (mnemonic.io)
// Date: 2023-10-27
// Level: high
// Description: Detects the execution of rundll32 that leads to an external network connection.
// The malware Pikabot has been seen to use this technique to initiate C2-communication through hard-coded Windows binaries.
// MITRE Tactic: Command and Control
// Tags: attack.command-and-control, attack.t1573, detection.emerging-threats
// False Positives:
//   - Unlikely

DeviceNetworkEvents
| where (InitiatingProcessFolderPath endswith "\\SearchFilterHost.exe" or InitiatingProcessFolderPath endswith "\\SearchProtocolHost.exe" or InitiatingProcessFolderPath endswith "\\sndvol.exe" or InitiatingProcessFolderPath endswith "\\wermgr.exe" or InitiatingProcessFolderPath endswith "\\wwahost.exe") and InitiatingProcessParentFileName =~ "rundll32.exe" and Protocol =~ "tcp"