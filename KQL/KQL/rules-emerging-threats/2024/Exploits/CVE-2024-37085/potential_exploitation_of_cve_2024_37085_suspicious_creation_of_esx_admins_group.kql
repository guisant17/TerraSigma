// Title: Potential Exploitation of CVE-2024-37085 - Suspicious Creation Of ESX Admins Group
// Author: frack113
// Date: 2024-07-29
// Level: high
// Description: Detects execution of the "net.exe" command in order to add a group named "ESX Admins".
// This could indicates a potential exploitation attempt of CVE-2024-37085, which allows an attacker to elevate their privileges to full administrative access on an domain-joined ESXi hypervisor.
// VMware ESXi hypervisors joined to an Active Directory domain consider any member of a domain group named "ESX Admins" to have full administrative access by default.
// MITRE Tactic: Execution
// Tags: attack.execution, cve.2024-37085, detection.emerging-threats

DeviceProcessEvents
| where ((ProcessCommandLine contains "/add" and ProcessCommandLine contains "/domain" and ProcessCommandLine contains "ESX Admins" and ProcessCommandLine contains "group") and ((FolderPath endswith "\\net.exe" or FolderPath endswith "\\net1.exe") or (ProcessVersionInfoOriginalFileName in~ ("net.exe", "net1.exe")))) or ((ProcessCommandLine contains "New-ADGroup" and ProcessCommandLine contains "ESX Admins") and ((FolderPath endswith "\\PowerShell.exe" or FolderPath endswith "\\pwsh.exe") or (ProcessVersionInfoOriginalFileName in~ ("PowerShell.exe", "pwsh.dll"))))