// Title: Potential MOVEit Transfer CVE-2023-34362 Exploitation - Dynamic Compilation Via Csc.EXE
// Author: @kostastsale
// Date: 2023-06-01
// Level: medium
// Description: Detects the execution of "csc.exe" via "w3wp.exe" process. MOVEit affected hosts execute "csc.exe" via the "w3wp.exe" process to dynamically compile malicious DLL files.
// MOVEit is affected by a critical vulnerability. Exploited hosts show evidence of dynamically compiling a DLL and writing it under C:\\Windows\\Microsoft\.NET\\Framework64\\v4\.0\.30319\\Temporary ASP\.NET Files\\root\\([a-z0-9]{5,12})\\([a-z0-9]{5,12})\\App_Web_[a-z0-9]{5,12}\.dll.
// Hunting Opportunity
// Events from IIS dynamically compiling binaries via the csc.exe on behalf of the MOVEit application, especially since May 27th should be investigated.
// MITRE Tactic: Execution
// Tags: attack.execution, attack.t1059, cve.2023-34362, detection.emerging-threats
// False Positives:
//   - Initial software installation and software updates.

DeviceProcessEvents
| where FolderPath endswith "\\csc.exe" and InitiatingProcessCommandLine contains "moveitdmz pool" and InitiatingProcessFolderPath endswith "\\w3wp.exe"