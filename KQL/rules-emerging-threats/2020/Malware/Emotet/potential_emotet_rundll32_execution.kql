// Title: Potential Emotet Rundll32 Execution
// Author: FPT.EagleEye
// Date: 2020-12-25
// Level: critical
// Description: Detecting Emotet DLL loading by looking for rundll32.exe processes with command lines ending in ,RunDLL or ,Control_RunDLL
// MITRE Tactic: Defense Evasion
// Tags: attack.defense-evasion, attack.t1218.011, detection.emerging-threats

DeviceProcessEvents
| where ((ProcessCommandLine endswith ",RunDLL" or ProcessCommandLine endswith ",Control_RunDLL") and (FolderPath endswith "\\rundll32.exe" or ProcessVersionInfoOriginalFileName =~ "RUNDLL32.EXE")) and (not((InitiatingProcessFolderPath endswith "\\tracker.exe" or (ProcessCommandLine endswith ".dll,Control_RunDLL" or ProcessCommandLine endswith ".dll\",Control_RunDLL" or ProcessCommandLine endswith ".dll',Control_RunDLL"))))