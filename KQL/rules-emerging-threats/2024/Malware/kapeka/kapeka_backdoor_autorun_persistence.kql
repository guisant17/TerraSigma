// Title: Kapeka Backdoor Autorun Persistence
// Author: Swachchhanda Shrawan Poudel
// Date: 2024-07-03
// Level: high
// Description: Detects the setting of a new value in the Autorun key that is used by the Kapeka backdoor for persistence.
// MITRE Tactic: Privilege Escalation
// Tags: attack.privilege-escalation, attack.persistence, attack.t1547.001, detection.emerging-threats

DeviceRegistryEvents
| where (RegistryValueData contains ":\\WINDOWS\\system32\\rundll32.exe" and RegistryValueData contains ".wll" and RegistryValueData contains "#1") and RegistryKey contains "\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run" and (RegistryKey endswith "\\Sens Api" or RegistryKey endswith "\\OneDrive")