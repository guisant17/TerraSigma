// Title: CVE-2021-31979 CVE-2021-33771 Exploits
// Author: Sittikorn S, frack113
// Date: 2021-07-16
// Level: critical
// Description: Detects patterns as noticed in exploitation of Windows CVE-2021-31979 CVE-2021-33771 vulnerability and DevilsTongue malware by threat group Sourgum
// MITRE Tactic: Initial Access
// Tags: attack.initial-access, attack.execution, attack.credential-access, attack.t1566, attack.t1203, cve.2021-33771, cve.2021-31979, detection.emerging-threats
// False Positives:
//   - Unlikely

DeviceRegistryEvents
| where (RegistryKey endswith "CLSID\\{CF4CC405-E2C5-4DDD-B3CE-5E7582D8C9FA}\\InprocServer32\\(Default)" or RegistryKey endswith "CLSID\\{7C857801-7381-11CF-884D-00AA004B2E24}\\InProcServer32\\(Default)") and (not((RegistryValueData endswith "system32\\wbem\\wmiutils.dll" or RegistryValueData endswith "system32\\wbem\\wbemsvc.dll")))