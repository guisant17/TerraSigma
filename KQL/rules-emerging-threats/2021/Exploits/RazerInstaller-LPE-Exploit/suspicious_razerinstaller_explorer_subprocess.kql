// Title: Suspicious RazerInstaller Explorer Subprocess
// Author: Florian Roth (Nextron Systems), Maxime Thiebaut
// Date: 2021-08-23
// Level: high
// Description: Detects a explorer.exe sub process of the RazerInstaller software which can be invoked from the installer to select a different installation folder but can also be exploited to escalate privileges to LOCAL SYSTEM
// MITRE Tactic: Defense Evasion
// Tags: attack.defense-evasion, attack.privilege-escalation, attack.t1553, detection.emerging-threats
// False Positives:
//   - User selecting a different installation folder (check for other sub processes of this explorer.exe process)

DeviceProcessEvents
| where ((ProcessIntegrityLevel in~ ("System", "S-1-16-16384")) and InitiatingProcessFolderPath endswith "\\RazerInstaller.exe") and (not(FolderPath startswith "C:\\Windows\\Installer\\Razer\\Installer\\"))