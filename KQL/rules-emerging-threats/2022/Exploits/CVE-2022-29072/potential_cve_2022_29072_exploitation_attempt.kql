// Title: Potential CVE-2022-29072 Exploitation Attempt
// Author: frack113, @kostastsale
// Date: 2022-04-17
// Level: high
// Description: Detects potential exploitation attempts of CVE-2022-29072, a 7-Zip privilege escalation and command execution vulnerability.
// 7-Zip version 21.07 and earlier on Windows allows privilege escalation (CVE-2022-29072) and command execution when a file with the .7z extension is dragged to the Help>Contents area. This is caused by misconfiguration of 7z.dll and a heap overflow.
// The command runs in a child process under the 7zFM.exe process.
// MITRE Tactic: Execution
// Tags: attack.execution, cve.2022-29072, detection.emerging-threats

DeviceProcessEvents
| where (((FolderPath endswith "\\cmd.exe" or FolderPath endswith "\\powershell.exe" or FolderPath endswith "\\pwsh.exe") or (ProcessVersionInfoOriginalFileName in~ ("Cmd.Exe", "PowerShell.EXE", "pwsh.dll"))) and InitiatingProcessFolderPath endswith "\\7zFM.exe") and (not((((ProcessCommandLine contains " /c " or ProcessCommandLine contains " /k " or ProcessCommandLine contains " /r ") or (ProcessCommandLine endswith ".bat" or ProcessCommandLine endswith ".cmd" or ProcessCommandLine endswith ".ps1")) or isnull(ProcessCommandLine))))