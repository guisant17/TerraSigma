// Title: Potential CVE-2022-22954 Exploitation Attempt - VMware Workspace ONE Access Remote Code Execution
// Author: @kostastsale
// Date: 2022-04-25
// Level: medium
// Description: Detects potential exploitation attempt of CVE-2022-22954, a remote code execution vulnerability in VMware Workspace ONE Access and Identity Manager.
// As reported by Morphisec, part of the attack chain, threat actors used PowerShell commands that executed as a child processes of the legitimate Tomcat "prunsrv.exe" process application.
// MITRE Tactic: Execution
// Tags: attack.execution, attack.initial-access, attack.t1059.006, attack.t1190, cve.2022-22954, detection.emerging-threats
// False Positives:
//   - Some false positives are possible as part of a custom script implementation from admins executed with cmd.exe as the child process.

DeviceProcessEvents
| where InitiatingProcessFolderPath endswith "\\prunsrv.exe" and ((ProcessCommandLine contains "/c powershell" and FolderPath endswith "\\cmd.exe") or FolderPath endswith "\\powershell.exe")