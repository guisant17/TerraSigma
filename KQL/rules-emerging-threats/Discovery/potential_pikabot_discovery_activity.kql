// Title: Potential Pikabot Discovery Activity
// Author: Andreas Braathen (mnemonic.io)
// Date: 2023-10-27
// Level: high
// Description: Detects system discovery activity carried out by Pikabot, such as incl. network, user info and domain groups.
// The malware Pikabot has been seen to use this technique as part of its C2-botnet registration with a short collection time frame (less than 1 minute).
// MITRE Tactic: Discovery
// Tags: attack.discovery, attack.t1016, attack.t1049, attack.t1087, detection.emerging-threats
// False Positives:
//   - Unlikely

DeviceProcessEvents
| where (ProcessCommandLine in~ ("ipconfig.exe /all", "netstat.exe -aon", "whoami.exe /all")) and (InitiatingProcessParentFileName endswith "\\rundll32.exe" or (InitiatingProcessFolderPath endswith "\\SearchFilterHost.exe" or InitiatingProcessFolderPath endswith "\\SearchProtocolHost.exe"))