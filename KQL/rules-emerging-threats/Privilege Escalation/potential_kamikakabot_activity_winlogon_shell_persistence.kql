// Title: Potential KamiKakaBot Activity - Winlogon Shell Persistence
// Author: Nasreddine Bencherchali (Nextron Systems), X__Junior
// Date: 2024-03-22
// Level: high
// Description: Detects changes to the "Winlogon" registry key where a process will set the value of the "Shell" to a value that was observed being used by KamiKakaBot samples in order to achieve persistence.
// MITRE Tactic: Privilege Escalation
// Tags: attack.privilege-escalation, attack.persistence, attack.t1547.001, detection.emerging-threats
// False Positives:
//   - Unlikely

DeviceRegistryEvents
| where (RegistryValueData contains "-nop -w h" and RegistryValueData contains "$env" and RegistryValueData contains "explorer.exe" and RegistryValueData contains "Start-Process") and RegistryKey endswith "\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\Shell"