// Title: Potential BearLPE Exploitation
// Author: Olaf Hartong
// Date: 2019-05-22
// Level: high
// Description: Detects potential exploitation of the BearLPE exploit using Task Scheduler ".job" import arbitrary DACL write\par
// MITRE Tactic: Persistence
// Tags: attack.persistence, attack.execution, attack.privilege-escalation, attack.t1053.005, car.2013-08-001, detection.emerging-threats

DeviceProcessEvents
| where (ProcessCommandLine contains "/change" and ProcessCommandLine contains "/TN" and ProcessCommandLine contains "/RU" and ProcessCommandLine contains "/RP") and (FolderPath endswith "\\schtasks.exe" or ProcessVersionInfoOriginalFileName =~ "schtasks.exe")