// Title: Exploiting SetupComplete.cmd CVE-2019-1378
// Author: Florian Roth (Nextron Systems), oscd.community, Jonhnathan Ribeiro
// Date: 2019-11-15
// Level: high
// Description: Detects exploitation attempt of privilege escalation vulnerability via SetupComplete.cmd and PartnerSetupComplete.cmd described in CVE-2019-1378
// MITRE Tactic: Persistence
// Tags: attack.persistence, attack.defense-evasion, attack.privilege-escalation, attack.t1068, attack.execution, attack.t1059.003, attack.t1574, cve.2019-1378, detection.emerging-threats

DeviceProcessEvents
| where ((InitiatingProcessCommandLine contains "\\cmd.exe" and InitiatingProcessCommandLine contains "/c" and InitiatingProcessCommandLine contains "C:\\Windows\\Setup\\Scripts\\") and (InitiatingProcessCommandLine endswith "SetupComplete.cmd" or InitiatingProcessCommandLine endswith "PartnerSetupComplete.cmd")) and (not((FolderPath startswith "C:\\Windows\\System32\\" or FolderPath startswith "C:\\Windows\\SysWOW64\\" or FolderPath startswith "C:\\Windows\\WinSxS\\" or FolderPath startswith "C:\\Windows\\Setup\\")))