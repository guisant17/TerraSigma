// Title: Potential KamiKakaBot Activity - Shutdown Schedule Task Creation
// Author: Nasreddine Bencherchali (Nextron Systems), X__Junior (Nextron Systems)
// Date: 2024-03-22
// Level: medium
// Description: Detects the creation of a schedule task that runs weekly and execute the "shutdown /l /f" command.
// This behavior was observed being used by KamiKakaBot samples in order to achieve persistence on a system.
// MITRE Tactic: Persistence
// Tags: attack.persistence, detection.emerging-threats

DeviceProcessEvents
| where ((ProcessCommandLine contains " /create " and ProcessCommandLine contains "shutdown /l /f" and ProcessCommandLine contains "WEEKLY") and FolderPath endswith "\\schtasks.exe") and (not((AccountName contains "AUTHORI" or AccountName contains "AUTORI")))