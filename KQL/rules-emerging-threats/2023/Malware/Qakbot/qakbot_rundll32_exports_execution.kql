// Title: Qakbot Rundll32 Exports Execution
// Author: X__Junior (Nextron Systems)
// Date: 2023-05-24
// Level: critical
// Description: Detects specific process tree behavior of a "rundll32" execution with exports linked with Qakbot activity.
// MITRE Tactic: Defense Evasion
// Tags: attack.defense-evasion, attack.execution, detection.emerging-threats
// False Positives:
//   - Unlikely

DeviceProcessEvents
| where (ProcessCommandLine endswith "aslr" or ProcessCommandLine endswith "bind" or ProcessCommandLine endswith "DrawThemeIcon" or ProcessCommandLine endswith "GG10" or ProcessCommandLine endswith "GL70" or ProcessCommandLine endswith "jhbvygftr" or ProcessCommandLine endswith "kjhbhkjvydrt" or ProcessCommandLine endswith "LS88" or ProcessCommandLine endswith "Motd" or ProcessCommandLine endswith "N115" or ProcessCommandLine endswith "next" or ProcessCommandLine endswith "Nikn" or ProcessCommandLine endswith "print" or ProcessCommandLine endswith "qqqb" or ProcessCommandLine endswith "qqqq" or ProcessCommandLine endswith "RS32" or ProcessCommandLine endswith "Test" or ProcessCommandLine endswith "Time" or ProcessCommandLine endswith "Updt" or ProcessCommandLine endswith "vips" or ProcessCommandLine endswith "Wind" or ProcessCommandLine endswith "WW50" or ProcessCommandLine endswith "X555" or ProcessCommandLine endswith "XL55" or ProcessCommandLine endswith "xlAutoOpen" or ProcessCommandLine endswith "XS88") and ((ProcessCommandLine contains ":\\ProgramData\\" or ProcessCommandLine contains ":\\Users\\Public\\" or ProcessCommandLine contains "\\AppData\\Local\\Temp\\" or ProcessCommandLine contains "\\AppData\\Roaming\\") and FolderPath endswith "\\rundll32.exe" and (InitiatingProcessFolderPath endswith "\\cmd.exe" or InitiatingProcessFolderPath endswith "\\cscript.exe" or InitiatingProcessFolderPath endswith "\\curl.exe" or InitiatingProcessFolderPath endswith "\\mshta.exe" or InitiatingProcessFolderPath endswith "\\powershell.exe" or InitiatingProcessFolderPath endswith "\\pwsh.exe" or InitiatingProcessFolderPath endswith "\\wscript.exe"))