// Title: Potential Pikabot Hollowing Activity
// Author: Andreas Braathen (mnemonic.io)
// Date: 2023-10-27
// Level: high
// Description: Detects the execution of rundll32 that leads to the invocation of legitimate Windows binaries.
// The malware Pikabot has been seen to use this technique for process hollowing through hard-coded Windows binaries
// MITRE Tactic: Privilege Escalation
// Tags: attack.privilege-escalation, attack.defense-evasion, attack.t1055.012, detection.emerging-threats
// False Positives:
//   - Unlikely

DeviceProcessEvents
| where ((FolderPath endswith "\\SearchFilterHost.exe" or FolderPath endswith "\\SearchProtocolHost.exe" or FolderPath endswith "\\sndvol.exe" or FolderPath endswith "\\wermgr.exe" or FolderPath endswith "\\wwahost.exe") and InitiatingProcessFolderPath endswith "\\rundll32.exe") and (not((FolderPath endswith "\\sndvol.exe" and InitiatingProcessCommandLine contains "mmsys.cpl")))