// Title: UNC4841 - SSL Certificate Exfiltration Via Openssl
// Author: Nasreddine Bencherchali (Nextron Systems)
// Date: 2023-06-16
// Level: high
// Description: Detects the execution of "openssl" to connect to an IP address. This techniques was used by UNC4841 to exfiltrate SSL certificates and as a C2 channel with named pipes. Investigate commands executed in the temporal vicinity of this command.
// MITRE Tactic: Defense Evasion
// Tags: attack.defense-evasion, attack.t1140, detection.emerging-threats

DeviceProcessEvents
| where (ProcessCommandLine contains ":443" or ProcessCommandLine contains ":8080") and (ProcessCommandLine contains "s_client" and ProcessCommandLine contains "-quiet" and ProcessCommandLine contains "-connect") and ProcessCommandLine matches regex "[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}" and FolderPath endswith "/openssl"